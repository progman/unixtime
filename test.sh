#!/bin/bash
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# 0.0.4
# Alexey Potehin <gnuplanet@gmail.com>, http://www.gnuplanet.ru/doc/cv
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
APP='./bin/unixtime';
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# run app
function run_app()
{
	local RESULT=0;
	local STDOUT;

	if [ "${FLAG_VALGRIND}" != "1" ];
	then
		STDOUT=$("${APP}" "${@}");
		RESULT="${?}";
	else
		local LOG_ID=0;
		local LOG_NAME;

		while true;
		do
			LOG_NAME=$(printf "valgrind.%03u\n" ${LOG_ID});

			if [ ! -e "${LOG_NAME}" ];
			then
				break;
			fi

			(( LOG_ID++ ));
		done

		STDOUT=$(valgrind --tool=memcheck --leak-check=yes --leak-check=full --show-reachable=yes --log-file="${LOG_NAME}" "${APP}" "${@}");
		RESULT="${?}";
	fi

	if [ "${STDOUT}" != "" ];
	then
		echo "${STDOUT}";
	fi

	return "${RESULT}";
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# test1
function test1()
{
	local A='04.11.2012 15:41:08';
	local B=$(run_app --to '%d.%m.%Y %H:%M:%S' "${A}" < /dev/null);
	local C=$(run_app --from '%d.%m.%Y %H:%M:%S' "${B}" < /dev/null);

	if [ "${A}" != "${C}" ];
	then
		echo "${A}";
		echo "${B}";
		echo "${C}";
		echo "ERROR[test1]: result different";
		exit 1;
	fi
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# test2
function test2()
{
	local X='2012.11.04-15.41.08';
	local Y=$(run_app --to '%Y.%m.%d-%H.%M.%S' "${X}" < /dev/null);
	local Z=$(run_app --from '%Y.%m.%d-%H.%M.%S' "${Y}" < /dev/null);

	if [ "${X}" != "${Z}" ];
	then
		echo "${X}";
		echo "${Y}";
		echo "${Z}";
		echo "ERROR[test2]: result different";
		exit 1;
	fi
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# test3
function test3()
{
	local TMP1;
	TMP1="$(mktemp)";
	if [ "${?}" != "0" ];
	then
		echo "can't make tmp file";
		exit 1;
	fi

	local TMP2;
	TMP2="$(mktemp)";
	if [ "${?}" != "0" ];
	then
		echo "can't make tmp file";
		exit 1;
	fi

	local TMP3;
	TMP3="$(mktemp)";
	if [ "${?}" != "0" ];
	then
		echo "can't make tmp file";
		exit 1;
	fi

	echo '04.11.2012 15:41:08' >> "${TMP1}";
	echo '04.11.2012 15:41:09' >> "${TMP1}";
	echo '04.11.2012 15:41:10' >> "${TMP1}";

	cat "${TMP1}" | run_app --to   '%d.%m.%Y %H:%M:%S' -- &> "${TMP2}";
	cat "${TMP2}" | run_app --from '%d.%m.%Y %H:%M:%S' -- &> "${TMP3}";

	local HASH1=$(md5sum "${TMP1}" | awk '{print $1}');
	local HASH2=$(md5sum "${TMP3}" | awk '{print $1}');

	if [ "${HASH1}" != "${HASH2}" ];
	then
		echo "TMP1:${TMP1}"; cat "${TMP1}";
		echo "TMP2:${TMP2}"; cat "${TMP2}";
		echo "TMP3:${TMP3}"; cat "${TMP3}";
		echo "ERROR[test3]: result different";
		exit 1;
	fi

	rm -rf "${TMP1}" &> /dev/null;
	rm -rf "${TMP2}" &> /dev/null;
	rm -rf "${TMP3}" &> /dev/null;
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# test4
function test4()
{
	local X;
	X=$(echo -e "04.11.2012 15:41:08\n04.11.2012 15:41:09" | run_app --to '%d.%m.%Y %H:%M:%S' -- | run_app --from '%d.%m.%Y %H:%M:%S' -- | tail -n 1);

	if [ "${X}" != "04.11.2012 15:41:09" ];
	then
		echo "${X}";
		echo "ERROR[test4]: result different";
		exit 1;
	fi
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# test5
function test5()
{
	local X;
	local Y;

	X=$(echo -e "04.11.2012 15:41:09"    | run_app --to '%d.%m.%Y %H:%M:%S' -- );
	Y=$(echo -e "04.11.2012 03:41:09 PM" | run_app --to '%d.%m.%Y %I:%M:%S %p' -- );

	if [ "${X}" != "${Y}" ];
	then
		echo "${X}";
		echo "${Y}";
		echo "ERROR[test5.1]: result different";
		exit 1;
	fi


	X=$(echo -e "04.11.2012 04:41:09"    | run_app --to '%d.%m.%Y %H:%M:%S' -- );
	Y=$(echo -e "04.11.2012 04:41:09 am" | run_app --to '%d.%m.%Y %I:%M:%S %p' -- );

	if [ "${X}" != "${Y}" ];
	then
		echo "${X}";
		echo "${Y}";
		echo "ERROR[test5.2]: result different";
		exit 1;
	fi
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# test6
function test6()
{
	local X="04.11.2012 14:41:09";

	local Y=$(echo -e "${X}" | run_app --to '%d.%m.%Y %H:%M:%S' -- | run_app --from '%d.%m.%Y %I:%M:%S %p' -- );

	local Z=$(echo -e "${Y}" | run_app --to '%d.%m.%Y %I:%M:%S %p' -- | run_app --from '%d.%m.%Y %H:%M:%S' -- );


	if [ "${X}" != "${Z}" ];
	then
		echo "${X}";
		echo "${Y}";
		echo "${Z}";
		echo "ERROR[test6]: result different";
		exit 1;
	fi
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# test6
function test7()
{
	local A;
	local B;

	A='1528799349';
	B=$(run_app --to   '%Y-%m-%d %H:%M:%S'    '2018-06-12 13:29:09');

	if [ "${A}" != "${B}" ];
	then
		echo "${A}";
		echo "${B}";
		echo "ERROR[test7.1]: result different";
		exit 1;
	fi


	A='1528799349866429';
	B=$(run_app --to   '%Y-%m-%d %H:%M:%S.%s' '2018-06-12 13:29:09.866429');

	if [ "${A}" != "${B}" ];
	then
		echo "${A}";
		echo "${B}";
		echo "ERROR[test7.2]: result different";
		exit 1;
	fi


	A='2018-06-12 13:29:09';
	B=$(run_app --from '%Y-%m-%d %H:%M:%S'    1528799349);

	if [ "${A}" != "${B}" ];
	then
		echo "${A}";
		echo "${B}";
		echo "ERROR[test7.3]: result different";
		exit 1;
	fi


	A='2018-06-12 13:29:09.866429';
	B=$(run_app --from '%Y-%m-%d %H:%M:%S.%s' 1528799349866429);

	if [ "${A}" != "${B}" ];
	then
		echo "${A}";
		echo "${B}";
		echo "ERROR[test7.4]: result different";
		exit 1;
	fi
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# check depends
function check_prog()
{
	for i in ${1};
	do
		if [ "$(which ${i})" == "" ];
		then
			echo "FATAL: you must install \"${i}\"...";
			return 1;
		fi
	done

	return 0;
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# general function
function main()
{
	if [ ! -e "${APP}" ];
	then
		echo "ERROR: make it";
		return 1;
	fi


	check_prog "awk cat echo md5sum mktemp rm tail";
	if [ "${?}" != "0" ];
	then
		return 1;
	fi


	test1;
	test2;
	test3;
	test4;
	test5;
	test6;
	test7;


	echo "ok, test passed";
	return 0;
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
main "${@}";

exit "${?}";
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
